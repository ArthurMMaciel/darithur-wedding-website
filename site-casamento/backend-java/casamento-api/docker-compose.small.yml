version: "3.9"

services:
  # Ajustes leves no backend para caber em 1 GB
  backend:
    environment:
      - EVOLUTION_API_BASE_URL=http://evolution-api:8080
      - JAVA_OPTS=${JAVA_OPTS}
      - SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE=5
      # Rabbit removido: nenhuma autoconfiguração necessária

  # Postgres com parâmetros conservadores
  postgres:
    command: [
      "postgres",
      "-c","shared_buffers=32MB",
      "-c","work_mem=4MB",
      "-c","maintenance_work_mem=32MB",
      "-c","effective_cache_size=128MB",
      "-c","max_connections=30"
    ]

  # Redis para Evolution
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "no", "--maxmemory", "128mb", "--maxmemory-policy", "allkeys-lru"]
    networks: [internal]

  # Evolution API (não exposta publicamente)
  evolution-api:
    image: evoapicloud/evolution-api:latest
    restart: unless-stopped
    depends_on: [postgres, redis]
    environment:
      - SERVER_PORT=8080
      - NODE_OPTIONS=--max-old-space-size=256
      - JWT_SECRET=${JWT_SECRET}
      - AUTHENTICATION_API_KEY=${AUTHENTICATION_API_KEY}
      # Banco: usa o Postgres já existente
      - DATABASE_PROVIDER=postgresql
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_USERNAME=${POSTGRES_USER}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD}
      - DATABASE_NAME=evolution
      # Algumas builds usam DATABASE_URL; mantemos coerente
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/evolution?schema=public
      - CACHE_REDIS_URI=redis://redis:6379
    networks: [internal]

networks:
  internal:
    external: false
